<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/MIGRATION_GUIDE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MIGRATION_GUIDE.md" />
              <option name="updatedContent" value="# Migration Guide: SQLite → PostgreSQL&#10;&#10;## Quick Summary&#10;&#10;**What changed:**&#10;- Database: SQLite (`dev.db` file) → PostgreSQL (cloud-hosted)&#10;- JSON fields: Stored as strings → Native JSON/JSONB&#10;- Arrays: Stored as strings → Native array type&#10;- Multi-user: Not supported → Full user management&#10;- Access: Local file → Global cloud database&#10;&#10;---&#10;&#10;## Step-by-Step Migration&#10;&#10;### 1. Backup Existing Data (Optional)&#10;&#10;If you have important tasks/events in SQLite:&#10;&#10;```bash&#10;cd app&#10;# Export current data&#10;npx prisma db pull&#10;# Save a copy of dev.db&#10;cp prisma/dev.db prisma/dev.db.backup&#10;```&#10;&#10;### 2. Setup PostgreSQL Database&#10;&#10;Follow **DATABASE_SETUP.md** to:&#10;1. Create a Neon/Supabase account (free)&#10;2. Create a PostgreSQL database&#10;3. Get the connection string&#10;&#10;### 3. Update Environment Variables&#10;&#10;**Local (.env file in `app/` folder):**&#10;```env&#10;DATABASE_URL=&quot;postgresql://user:pass@host.neon.tech/db?sslmode=require&quot;&#10;DIRECT_URL=&quot;postgresql://user:pass@host.neon.tech/db?sslmode=require&quot;&#10;```&#10;&#10;**Vercel (Dashboard → Settings → Environment Variables):**&#10;Add the same `DATABASE_URL` and `DIRECT_URL` to all environments.&#10;&#10;### 4. Run Migrations&#10;&#10;```bash&#10;cd app&#10;&#10;# Generate Prisma Client for new schema&#10;npx prisma generate&#10;&#10;# Create tables in PostgreSQL&#10;npx prisma migrate dev --name init_postgresql&#10;&#10;# Verify migration succeeded&#10;npx prisma studio&#10;```&#10;&#10;### 5. Update Code Imports&#10;&#10;The new database utilities are in `lib/db-postgres.ts`.&#10;&#10;**Old code:**&#10;```typescript&#10;import { getTasks, createTask } from '@/lib/db'&#10;```&#10;&#10;**New code (same!):**&#10;The old `lib/db.ts` will be updated to use PostgreSQL internally.&#10;No code changes needed in most cases.&#10;&#10;### 6. Test Everything&#10;&#10;```bash&#10;# Start dev server&#10;cd app&#10;npm run dev&#10;```&#10;&#10;Test:&#10;- ✅ Create a task&#10;- ✅ Run a task&#10;- ✅ View events&#10;- ✅ Update settings&#10;- ✅ Sandbox operations&#10;&#10;### 7. Deploy to Vercel&#10;&#10;```bash&#10;git add .&#10;git commit -m &quot;Migrate to PostgreSQL for global database&quot;&#10;git push origin main&#10;```&#10;&#10;Vercel will:&#10;1. Detect environment variables&#10;2. Run `prisma generate`&#10;3. Run `prisma migrate deploy` (production migrations)&#10;4. Build and deploy&#10;&#10;---&#10;&#10;## What's New&#10;&#10;### Multi-User Support&#10;&#10;```typescript&#10;// Create a user&#10;const user = await createUser({&#10;  email: 'you@example.com',&#10;  name: 'Your Name',&#10;  username: 'yourusername'&#10;})&#10;&#10;// Create user-specific task&#10;const task = await createTask({&#10;  userId: user.id,&#10;  title: 'My Task',&#10;  type: 'shell',&#10;  isPublic: false // Only you can see it&#10;})&#10;&#10;// Or create global task (no userId)&#10;const globalTask = await createTask({&#10;  title: 'Public Task',&#10;  isPublic: true // Everyone can see it&#10;})&#10;```&#10;&#10;### Native JSON Fields&#10;&#10;**Before (SQLite):**&#10;```typescript&#10;// Had to parse JSON strings&#10;const payload = JSON.parse(task.payload || '{}')&#10;const tags = JSON.parse(task.tags || '[]')&#10;```&#10;&#10;**After (PostgreSQL):**&#10;```typescript&#10;// Native JSON, no parsing needed&#10;const payload = task.payload // Already an object!&#10;const tags = task.tags // Already an array!&#10;```&#10;&#10;### LLM Sessions&#10;&#10;```typescript&#10;// Create a conversation session&#10;const session = await createLLMSession({&#10;  sessionId: 'my-chat-session',&#10;  title: 'Discussion about X',&#10;  systemPrompt: 'You are a helpful assistant'&#10;})&#10;&#10;// Add messages&#10;await addLLMMessage({&#10;  sessionId: 'my-chat-session',&#10;  role: 'user',&#10;  content: 'Hello!'&#10;})&#10;&#10;await addLLMMessage({&#10;  sessionId: 'my-chat-session',&#10;  role: 'assistant',&#10;  content: 'Hi! How can I help?'&#10;})&#10;&#10;// Get full session with history&#10;const fullSession = await getLLMSession('my-chat-session')&#10;console.log(fullSession.messages) // All messages in order&#10;```&#10;&#10;### Sandbox File Tracking&#10;&#10;```typescript&#10;// Save a file (tracked in DB)&#10;await saveSandboxFile({&#10;  userId: currentUser.id,&#10;  path: 'notes/ideas.txt',&#10;  content: 'My brilliant ideas...',&#10;  mimeType: 'text/plain'&#10;})&#10;&#10;// List all files&#10;const files = await listSandboxFiles(currentUser.id)&#10;&#10;// Soft delete (keeps in DB)&#10;await deleteSandboxFile(currentUser.id, 'notes/old.txt')&#10;```&#10;&#10;### Audit Logs&#10;&#10;```typescript&#10;// Log important actions&#10;await createAuditLog({&#10;  userId: currentUser.id,&#10;  action: 'delete_task',&#10;  resource: `task:${taskId}`,&#10;  ipAddress: request.ip,&#10;  userAgent: request.headers['user-agent']&#10;})&#10;&#10;// Query logs&#10;const logs = await getAuditLogs({&#10;  userId: currentUser.id,&#10;  action: 'delete_task',&#10;  limit: 50&#10;})&#10;```&#10;&#10;---&#10;&#10;## Breaking Changes&#10;&#10;### 1. Settings Model&#10;&#10;**Before:**&#10;```typescript&#10;model Settings {&#10;  id          Int      @id @default(1) // Fixed ID&#10;  runnerUrl   String?&#10;  runnerToken String?&#10;  updatedAt   DateTime @updatedAt&#10;}&#10;```&#10;&#10;**After:**&#10;```typescript&#10;model Settings {&#10;  id          String   @id @default(uuid())&#10;  userId      String?  @unique // Per-user settings&#10;  runnerUrl   String?&#10;  runnerToken String?&#10;  preferences Json?    // Flexible preferences&#10;  updatedAt   DateTime @updatedAt&#10;  createdAt   DateTime @default(now())&#10;}&#10;```&#10;&#10;**Migration:**&#10;```typescript&#10;// Old: getSettings()&#10;const settings = await getSettings()&#10;&#10;// New: getSettings(userId) or getSettings() for global&#10;const settings = await getSettings(currentUser?.id)&#10;```&#10;&#10;### 2. Task Payload &amp; Tags&#10;&#10;**Before:**&#10;```typescript&#10;// Payload and tags were strings&#10;payload: String?  // Had to JSON.parse()&#10;tags: String?     // Had to JSON.parse()&#10;```&#10;&#10;**After:**&#10;```typescript&#10;// Native types&#10;payload: Json?    // Already parsed&#10;tags: String[]    // Native array&#10;```&#10;&#10;**Code Update:**&#10;```typescript&#10;// Old&#10;const payload = JSON.parse(task.payload || '{}')&#10;const tags = JSON.parse(task.tags || '[]')&#10;&#10;// New&#10;const payload = task.payload // Already an object&#10;const tags = task.tags || [] // Already an array&#10;```&#10;&#10;### 3. Event Data&#10;&#10;Same as above - `data` field is now native `Json` instead of string.&#10;&#10;---&#10;&#10;## Rollback Plan&#10;&#10;If something goes wrong:&#10;&#10;### Option 1: Keep Using SQLite Locally&#10;&#10;Revert `schema.prisma`:&#10;```prisma&#10;datasource db {&#10;  provider = &quot;sqlite&quot;&#10;  url      = &quot;file:./dev.db&quot;&#10;}&#10;```&#10;&#10;Then:&#10;```bash&#10;npx prisma generate&#10;npm run dev&#10;```&#10;&#10;### Option 2: Restore from Backup&#10;&#10;```bash&#10;cp prisma/dev.db.backup prisma/dev.db&#10;npx prisma generate&#10;```&#10;&#10;### Option 3: Fresh PostgreSQL Setup&#10;&#10;Just re-run the setup steps with a new database.&#10;&#10;---&#10;&#10;## FAQ&#10;&#10;**Q: Do I lose my existing data?**  &#10;A: SQLite data is local-only. PostgreSQL is a fresh start. If you need to migrate data, export from SQLite and import manually.&#10;&#10;**Q: Is PostgreSQL free?**  &#10;A: Yes! Neon and Supabase have generous free tiers.&#10;&#10;**Q: What about performance?**  &#10;A: PostgreSQL is faster for multi-user scenarios and handles concurrent access much better.&#10;&#10;**Q: Can I use the same database from phone and laptop?**  &#10;A: Yes! That's the whole point of PostgreSQL - it's cloud-hosted and accessible from anywhere.&#10;&#10;**Q: What if Neon/Supabase goes down?**  &#10;A: They have 99.9% uptime SLAs. You can also export your data and migrate to another provider.&#10;&#10;---&#10;&#10;## Next Steps&#10;&#10;1. ✅ Complete DATABASE_SETUP.md&#10;2. ✅ Run migrations&#10;3. ✅ Test locally&#10;4. ✅ Deploy to Vercel&#10;5. ✅ Test on production&#10;6.  Enjoy global database access!&#10;&#10;**Your data is now accessible from all deployments and devices!** &#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>